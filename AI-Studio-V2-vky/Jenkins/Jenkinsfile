pipeline {
  agent any

  environment {
    REPO_URL = 'https://github.com/64SquaresApexLLP/AI-Studio-V2.git'
    FRONTEND_DIR  = 'AI-Studio-V2/Frontend'
    BACKEND_DIR = 'AI-Studio-V2/Backend'
    BRANCH = 'main'
    BUILD_STATUS = 'SUCCESS'
    TEAM_EMAILS = 'saurabhp@64-squares.com'
  }

  triggers {
    githubPush()
  }

  stages {
    stage('Pull Latest Code') {
      steps {
        script {
          withCredentials([usernamePassword(credentialsId: '8f94f14d-2ced-4ac1-827d-e69aad71f1fc', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
            if (fileExists('AI-Studio-V2/.git')) {
              dir('AI-Studio-V2') {
                echo "üîÅ Pulling latest code from branch ${BRANCH}..."
                sh 'git reset --hard'
                sh 'git clean -fd'
                sh "git pull https://${GIT_USER}:${GIT_TOKEN}@github.com/64SquaresApexLLP/AI-Studio-V2.git ${BRANCH}"
              }
            } else {
              echo "üÜï Cloning repository as fallback..."
              sh "rm -rf AI-Studio-V2"
              sh "git clone -b ${BRANCH} https://${GIT_USER}:${GIT_TOKEN}@github.com/64SquaresApexLLP/AI-Studio-V2.git"
            }

            dir('AI-Studio-V2') {
              def latestCommit = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
              echo "‚úÖ Checked out commit: ${latestCommit}"
            }
          }
        }
      }
    }

    stage('Install Frontend Dependencies') {
      steps {
        dir("${FRONTEND_DIR}") {
          sh 'npm install'
        }
      }
    }

    stage('Build Frontend') {
      steps {
        dir("${FRONTEND_DIR}") {
          sh 'npm run build'
        }
      }
    }

  stage('Set Up Python Backend') {
  steps {
    dir("${BACKEND_DIR}") {
      sh '''
        python3 -m venv venv
        ./venv/bin/pip install --upgrade pip
        ./venv/bin/pip install --cache-dir="$WORKSPACE/.pip-cache" -r requirements.txt
      '''
    }
  }
}

    stage('Validate Backend Code') {
      steps {
        dir("${BACKEND_DIR}") {
          sh './venv/bin/python3 -m py_compile main.py'
        }
      }
    }

stage('Start Backend (FastAPI) on Port 8077') {
  steps {
    dir("${BACKEND_DIR}") {
      sh '''
        echo "üåê Killing any existing process on port 8077..."
        fuser -k 8077/tcp || true

        echo "üöÄ Starting FastAPI backend via PM2..."

        export $(grep -v '^#' .env | xargs)

        pm2 delete backend || true

        pm2 start ./venv/bin/uvicorn \
          --name backend \
          --interpreter none \
          -- main:app --host 0.0.0.0 --port 8077
      '''
    }
  }
}



    stage('Send Team Email Notification') {
      steps {
        script {
          echo "üìß Sending email notification to team..."
          def commitInfo = ""
          def triggeredBy = ""

          try {
            dir('AI-Studio-V2') {
              commitInfo = sh(script: 'git log -1 --pretty=format:"%h - %an: %s"', returnStdout: true).trim()
              triggeredBy = sh(script: 'git log -1 --pretty=format:"%an (%ae)"', returnStdout: true).trim()
            }
          } catch (Exception e) {
            commitInfo = "Unable to fetch commit info"
            triggeredBy = "Unknown"
          }

          def emailSubject = ""
          def emailBody = ""

          if (env.BUILD_STATUS == 'SUCCESS') {
            emailSubject = "‚úÖ Deployment SUCCESS: AI-Studio-V2 [#${env.BUILD_NUMBER}]"
            emailBody = """
üéâ AI-Studio-V2 Deployment Successful!

üìã Build Info:
‚Ä¢ Job: ${env.JOB_NAME}
‚Ä¢ Build: #${env.BUILD_NUMBER}
‚Ä¢ Status: SUCCESS ‚úÖ
‚Ä¢ URL: ${env.BUILD_URL}

üì¶ Repo:
‚Ä¢ URL: ${env.REPO_URL}
‚Ä¢ Branch: ${env.BRANCH}
‚Ä¢ Commit: ${commitInfo}
‚Ä¢ Triggered by: ${triggeredBy}

‚úÖ Frontend built successfully
‚úÖ Backend running on port 8077
üåê Frontend served via NGINX

‚è∞ Time: ${new Date()}

This is an automated message from Jenkins CI/CD.
"""
          } else {
            emailSubject = "‚ùå Deployment FAILURE: AI-Studio-V2 [#${env.BUILD_NUMBER}]"
            emailBody = """
‚ö†Ô∏è Deployment Failed!

üìã Build Info:
‚Ä¢ Job: ${env.JOB_NAME}
‚Ä¢ Build: #${env.BUILD_NUMBER}
‚Ä¢ Status: FAILURE ‚ùå
‚Ä¢ URL: ${env.BUILD_URL}

üì¶ Repo:
‚Ä¢ Branch: ${env.BRANCH}
‚Ä¢ Commit: ${commitInfo}
‚Ä¢ Triggered by: ${triggeredBy}

‚è∞ Time: ${new Date()}

Please check Jenkins logs and take action.
"""
          }

          mail(
            to: env.TEAM_EMAILS,
            subject: emailSubject,
            body: emailBody
          )
        }
      }
    }
  }

  post {
    failure {
      script {
        env.BUILD_STATUS = 'FAILURE'
        echo "‚ùå Pipeline failed."
      }
    }

    success {
      echo "‚úÖ Pipeline completed successfully."
    }

    always {
      echo "üì° GitHub webhook active. Pipeline finished"
    }
  }
}
